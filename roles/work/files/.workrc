#!/usr/bin/env bash

# ================================================================================
# NU CLI Management Functions
# ================================================================================

nu-update-cli() {
  echo -e "\nğŸ”„ \033[1;34mUpdating NU CLI...\033[0m"
  echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  nu update
  echo -e "âœ… \033[1;32mNU CLI update completed\033[0m"
}

nu-update-projects() {
  echo -e "\nğŸ“‹ \033[1;35mUpdating NU Projects...\033[0m"
  echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  echo -e "ğŸ”§ Updating cljdev project..."
  nu proj update cljdev

  echo -e "âš™ï¸  Updating nudev project..."
  nu proj update nudev

  echo -e "ğŸ› ï¸  Updating nucli project..."
  nu proj update nucli

  echo -e "âœ… \033[1;32mProject updates completed\033[0m"
}

nu-setup-aws-credentials() {
  echo -e "\nğŸ” \033[1;33mConfiguring AWS Credentials...\033[0m"
  echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  echo -e "ğŸ”„ Resetting AWS credentials..."
  nu aws credentials reset

  echo -e "âš™ï¸  Setting up AWS credentials..."
  nu aws credentials setup

  echo -e "ğŸ”„ Refreshing AWS credentials..."
  nu aws credentials refresh

  echo -e "ğŸ‘¥ Setting up shared role credentials..."
  nu aws shared-role-credentials refresh --interactive
  nu aws shared-role-credentials refresh --account-alias=br --keep-policies admin/cs,admin,eng,prod-eng,databricks-mx-general,databricks-general,casual-dev,lending-engineering,shared-systems-resources

  echo -e "ğŸŒ Refreshing credentials for specific accounts..."
  nu aws credentials refresh --aws-account='mx'
  nu aws credentials refresh --aws-account='br'

  echo -e "ğŸ—ï¸  Setting up BR staging credentials..."
  nu aws shared-role-credentials refresh --account-alias br-staging --keep-policies admin/cs,admin,eng,prod-eng,databricks-mx-general,databricks-general,casual-dev,lending-engineering,shared-systems-resources

  echo -e "ğŸ“‹ Checking available credentials..."
  nu aws shared-role-credentials available --account-alias=br

  echo -e "âœ… \033[1;32mAWS credentials setup completed\033[0m"
}

nu-setup-dependencies() {
  echo -e "\nğŸ“¦ \033[1;35mLoading Dependencies...\033[0m"
  echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  echo -e "â˜• Logging into Maven CodeArtifact..."
  nu codeartifact login maven

  echo -e "ğŸ“¦ Logging into NPM CodeArtifact..."
  nu codeartifact login npm

  echo -e "âœ… \033[1;32mDependencies setup completed\033[0m"
}

nu-setup-co-environment() {
  echo -e "\nğŸ‡¨ğŸ‡´ \033[1;36mSetting up CO Environment...\033[0m"
  echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  echo -e "ğŸ” Setting up certificates..."
  nu-co certs setup --env prod
  nu-co certs setup --env staging

  echo -e "ğŸ« Setting up JWT authentication..."
  nu-co auth jwt --env prod
  nu-co auth jwt --env staging

  echo -e "ğŸ”„ Getting refresh tokens..."
  nu-co auth get-refresh-token --env prod --force
  nu-co auth get-refresh-token --env staging --force

  echo -e "ğŸŸï¸  Getting access tokens..."
  nu-co auth get-access-token --env prod
  nu-co auth get-access-token --env staging

  echo -e "âœ… \033[1;32mCO environment setup completed\033[0m"
}

nu-setup-ist-environment() {
  echo -e "\nğŸ›ï¸  \033[1;31mSetting up IST Environment...\033[0m"
  echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  echo -e "ğŸ” Setting up certificates..."
  nu-ist certs setup --env prod
  nu-ist certs setup --env staging

  echo -e "ğŸ”„ Getting refresh tokens..."
  nu-ist auth get-refresh-token --env prod --force
  nu-ist auth get-refresh-token --env staging --force

  echo -e "ğŸŸï¸  Getting access tokens..."
  nu-ist auth get-access-token --env prod
  nu-ist auth get-access-token --env staging

  echo -e "âœ… \033[1;32mIST environment setup completed\033[0m"
}

nu-setup-mx-environment() {
  echo -e "\nğŸ‡²ğŸ‡½ \033[1;32mSetting up MX Environment...\033[0m"
  echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  echo -e "ğŸ” Setting up certificates..."
  nu-mx certs setup --env prod
  nu-mx certs setup --env staging

  echo -e "ğŸ”„ Getting refresh tokens..."
  nu-mx auth get-refresh-token --env prod --force
  nu-mx auth get-refresh-token --env staging --force

  echo -e "ğŸŸï¸  Getting access tokens..."
  nu-mx auth get-access-token --env prod
  nu-mx auth get-access-token --env staging

  echo -e "âœ… \033[1;32mMX environment setup completed\033[0m"
}

# ================================================================================
# Main Refresh Function
# ================================================================================

nu-refresh() {
  echo -e "\nğŸš€ \033[1;37;44m Starting NU Environment Refresh \033[0m"
  echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  nu-update-projects
  nu-update-cli
  nu-setup-aws-credentials
  nu-setup-dependencies
  nu-setup-co-environment
  nu-setup-ist-environment
  nu-setup-mx-environment

  nu aws shared-role-credentials refresh --account-alias=br

  echo -e "\nğŸ‰ \033[1;37;42m NU Environment Refresh Completed Successfully! \033[0m"
  echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
}

# ================================================================================
# Development Functions
# ================================================================================

nu-mmr() {
  echo -e "\nğŸ“± \033[1;37;45m Starting Mini Meta Repo Development Environment \033[0m"
  echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  echo -e "ğŸ“± Creating iPhone 16 simulator..."
  xcrun simctl create 'iPhone 16 18-5' \
    com.apple.CoreSimulator.SimDeviceType.iPhone-16 \
    com.apple.CoreSimulator.SimRuntime.iOS-18-5

  echo -e "ğŸ”„ Booting simulator..."
  xcrun simctl boot 'iPhone 16 18-5'

  echo -e "ğŸ“‚ Navigating to mini-meta-repo..."
  cd ~/dev/nu/mini-meta-repo || return

  echo -e "ğŸ”§ Running monocli doctor..."
  monocli doctor

  echo -e "ğŸŒ Getting localization files..."
  monocli l10n get

  echo -e "ğŸ“¦ Getting Flutter desktop dependencies..."
  monocli deps get -p flutter-desktop

  echo -e "ğŸ” Getting CO staging certificates..."
  nu-co customer get-keys-and-certificates --env staging

  echo -e "ğŸš€ Launching Flutter app..."
  flutter run -d macos -t lib/main_desktop.dart
}

alias _dotfiles='cd "$HOME/.dotfiles/"'
alias __dotfiles='cd "$HOME/.dotfiles/" && nvim .'

alias _startup-kit='cd "$HOME/Akeptous/startup-kit/"'
alias __startup-kit='cd "$HOME/Akeptous/startup-kit/" && nvim .'
