#!/usr/bin/env bash

source "$(dirname "${BASH_SOURCE[0]}")/base"

readonly AKEPTOUS_REPOS=("akli" "cloud" "gifttech" "handbook")
readonly PERSONAL_REPOS=("kiln" "max-neef" "workbook")

# Connect dotfiles to GitHub
connect_github() {
    cd ~/.dotfiles || return
    git remote set-url origin git@github.com:brahayan-dev/dotfiles.git
}

# Set up SSH key for GitHub
set_ssh_key_to_github() {
    [[ "$(gh auth status)" != *"Active account: true"* ]] && gh auth login
    gh auth refresh -h github.com -s admin:ssh_signing_key
    gh ssh-key add "$HOME/.ssh/${CURRENT_USER}_rsa.pub" -t "${CURRENT_USER}-ssh"
}

# Create directory and clone repositories
clone_repos() {
    local owner="$1"
    local dir="$2"
    shift 2
    local repos=("$@")

    # Create Akeptous directory if it doesn't exist
    if [[ ! -d "$dir" ]]; then
        log_info "Creating directory at $dir"
        mkdir -p "$dir"
    fi

    cd "$dir" || return

    # Clone repositories using gh
    for repo in "${repos[@]}"; do
        if [[ ! -d "$repo" ]]; then
            log_info "Cloning $repo repository"
            gh repo clone "$owner/$repo" 
        fi
    done
}

# Execute connect command
execute_connect() {
    log_info "Connecting dotfiles to GitHub over SSH"
    connect_github
}

# Execute github command
execute_github() {
    log_info "Setting up GitHub SSH key"
    set_ssh_key_to_github
}

# Execute clone command
execute_clone() {
    log_info "Cloning Akeptous repositories from GitHub"
    clone_repos "akeptous" "$HOME/Akeptous" "${AKEPTOUS_REPOS[@]}"

    log_info "Cloning Private repositories from GitHub"
    clone_repos "brahayan-dev" "$HOME/Private" "${PERSONAL_REPOS[@]}"
}
