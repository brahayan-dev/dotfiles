#!/usr/bin/env bash
set -euo pipefail

RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
NC=$'\033[0m'

log_info() { printf '%s[INFO]%s %s\n' "$GREEN" "$NC" "$*"; }
log_error() { printf '%s[ERROR]%s %s\n' "$RED" "$NC" "$*" >&2; }

have() { command -v "$1" >/dev/null 2>&1; }

ensure_brew() {
  if have brew; then
    return 0
  fi

  log_info "Installing Homebrew"
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  if [[ -x /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  elif [[ -x /usr/local/bin/brew ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
  fi

  have brew || {
    log_error "Brew Not Found After Install"
    return 1
  }
}

ensure_deps_macos() {
  ensure_brew
  if ! have ansible; then
    log_info "Installing Ansible"
    brew install ansible
  fi
  if ! have lua; then
    log_info "Installing Lua"
    brew install lua
  fi
}

ensure_deps_linux() {
  if have apt-get; then
    if ! have ansible || ! have lua; then
      log_info "Updating Apt Index"
      sudo apt-get update
    fi

    if ! have ansible; then
      log_info "Installing Ansible"
      sudo apt-get install -y ansible
    fi
    if ! have lua; then
      log_info "Installing Lua"
      sudo apt-get install -y lua5.4
    fi
  else
    log_error "Could Not Detect Package Manager To Install Dependencies"
    return 1
  fi
}

main() {
  local os script
  os="$(uname -s)"

  case "$os" in
  Darwin)
    ensure_deps_macos
    if [[ -e "$HOME/.nurc" ]]; then
      script="systems/work.lua"
    else
      script="systems/life.lua"
    fi
    ;;
  Linux)
    ensure_deps_linux
    script="systems/linux.lua"
    ;;
  *)
    log_error "OS not supported: $os"
    return 1
    ;;
  esac

  exec lua "$script" "$@"
}

main "$@"
